# behind the scenes

![1](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/1.png)

Challenge cho chúng ta một file exe ở dạng PE32

![2](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/2.png)

Chạy thử file, chương trình yêu cầu nhập Flag, sai thì trả về ``wrong``

![3](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/3.png)

Mở file bằng ida, xem hàm main của chương trình

![4](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/4.png)

### Resolve API

Vào hàm ``sub_C32E80``, có thể thấy cách chương trình gọi API hơi lạ

![5](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/5.png)

xref theo biến ``apicall2``, ta tới được hàm ``implement2``, sau đó đi tiếp vào hàm ``MyVtImplementation`` -> ``APICALL``, ta gặp được biến ``APICALL::`vftable'``

![6](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/6.png)

Xem biến ``APICALL::`vftable'``, có thể thấy đây là một struct chứa địa chỉ của rất nhiều hàm khác nhau

![7](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/7.png)

Xem qua tất cả các hàm, có thể thấy chúng đều có một cấu trúc chung giống như hàm ``sub_401220`` dưới đây

![8](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/8.png)

Có thể thấy hàm trên truyền vào hai chuỗi hash, sau đó gọi hàm ``sub_402B80``, đọc qua code có thể thấy hàm này dùng PEB để ResolveAPI dựa vào 2 chuối hash được truyền vào

![9](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/9.png)

Tổng kết lại có thể thấy các hàm trong ``APICALL::`vftable'`` đều có 1 cách hoạt động chung, sử dụng hai chuỗi hash được khai báo để Resolve API, sau đó call API vừa resolve được với tham số là các tham số truyền vào của các hàm trên.

``APICALL::`vftable'`` ban đầu có thể là một class C++ chứa địa chỉ các hàm resolve API, tuy nhiên vì ida không load được cấu trúc của class nên chúng ta thấy nó ở dạng ``vftable``. Sau đó ta thấy 1 số hàm sẽ được gọi dưới dạng câu lệnh ``apicall1 + 8``,... đó chính là câu lệnh ``apicall1->GetProcAddr`` ở code gốc C++. Để thuận lợi cho việc đọc code và debug, mình sẽ SetIP và debug vào trước từng hàm để đổi tên chúng sang tên API mà hàm gọi ra.

![10](https://github.com/noobmannn/KCSC_CTF_2024/blob/0d7d091ea183b58f5fe85641243d14fcd4a475a0/behind%20the%20scenes/Img/10.png)

### Phân tích hàm main_handle

Sau khi gọi hàm ``sub_C32E80`` để load dll cần thiết và yêu cầu nhập Input, chương trình chạy đến hàm ``main_handle``. Có thể thấy hàm này bị obfuscate bằng cách chèn byte rác và chèn code rác vào chương trình

![11](https://github.com/noobmannn/KCSC_CTF_2024/blob/845ba24b603db4c0e76bd46a8a3215cf5cc9a2ca/behind%20the%20scenes/Img/11.png)

Nop đi byte và code rác, sau đó ấn P để Make Function, sau đó xem mã giả của hàm ``main_handle``

![12](https://github.com/noobmannn/KCSC_CTF_2024/blob/845ba24b603db4c0e76bd46a8a3215cf5cc9a2ca/behind%20the%20scenes/Img/12.png)

Có thể thấy tất cả các string quan trọng trong chương trình đều đã bị encrypt ở dạng Base64, và chỉ được decrypt bằng hàm ``decrypt_base64`` rồi mới sử dụng tiếp. Hàm ``main_handle`` đầu tiên lấy đường dẫn thư mục Temp trong máy, sau đó ghép nó với chuối ``Cachedata.bin``.  Cuối cùng đẩy toàn bộ đường dẫn trên vào biến Buffer. Sau đó chương trình gọi hàm ``readfilefromInternet``

![13](https://github.com/noobmannn/KCSC_CTF_2024/blob/845ba24b603db4c0e76bd46a8a3215cf5cc9a2ca/behind%20the%20scenes/Img/13.png)

Sau khi debug và phân tích, có thể thấy hàm ``readfilefromInternet`` tiến hành tải một file từ ``http://172.245.6.189:4444/test.txt`` sau đó viết nội dung file được tải vào file ``cachedata.bin``. Kết thúc quá trình trên, chương trình quay về hàm main, ghép đường dẫn thư mục Temp với chuỗi ``KCSC.dll`` sau đó gọi hàm ``decrypt_filedll``

![14](https://github.com/noobmannn/KCSC_CTF_2024/blob/845ba24b603db4c0e76bd46a8a3215cf5cc9a2ca/behind%20the%20scenes/Img/14.png)

Hàm này viết nội dung file ``cachedata.bin`` vào biến ``Block``, sau đó cho qua hai hàm ``rc4_ksa`` và ``rc4_prga`` để Decrypt data biến ``Block``, cuối cùng là ghi data của biến ``Block`` vào file ``KCSC.dll``.

![15](https://github.com/noobmannn/KCSC_CTF_2024/blob/845ba24b603db4c0e76bd46a8a3215cf5cc9a2ca/behind%20the%20scenes/Img/15.png)

Cuối cùng chương trình quay về hàm main, dùng ``LoadLibraryA`` để load ``KCSC.dll`` vào chương trình, sau đó dùng ``GetProcAddress`` để lấy địa chỉ hàm ``HelloWorld`` trong ``KCSC.dll``, cuối cùng dùng input nhập vào làm tham số và gọi hàm ``HelloWorld``, có vẻ đây chính là hàm encrpt và check flag. Nếu đúng thì chương trình in ra ``correct`` còn sai thì trả về ``wrong``.

### Phân tích hàm Encrypt Flag

Đầu tiên hàm tiến hành so sánh 12 kí tự đầu của input với chuỗi ``de(RYpt3d_bu``, nếu đúng thì chương trình tiến hành khai báo cipher và ciphertext, sau đó tiếp tục check độ dài flag có phải bằng 44 không, nếu có thì tiến hành encrypt input

![16](https://github.com/noobmannn/KCSC_CTF_2024/blob/1ce31dd1833783af1ae4ec12a50170c53f2262a6/behind%20the%20scenes/Img/16.png)

Sau khi encrpyt xong, input sẽ được check với ciphertext dưới đây

```python
enc = [0x0F, 0x21, 0xCB, 0x47, 0xF6, 0xB0, 0x0E, 0xA0, 0x69, 0x51, 
  0x5A, 0x08, 0x47, 0x7E, 0x21, 0xD5, 0x8E, 0x31, 0xF4, 0xD6, 
  0xAF, 0xD0, 0x9A, 0x40, 0x03, 0x2B, 0xD6, 0x4C, 0xD7, 0x58, 
  0xD1, 0x47, 0xD6, 0xA9, 0x9E, 0x29, 0x64, 0x73, 0xAA, 0x48, 
  0xDF, 0x46, 0xC2, 0xBA]
```

Sau khi phân tích code và debug, mình sẽ viết script để lấy flag

```python
from z3 import *

cipher = [0xD1, 0x46, 0x40, 0x91, 0x2F, 0x64, 0x42, 0xD6, 0xE9, 0x2D, 
  0x19, 0x28, 0x10, 0xC8, 0x79, 0x88, 0x70, 0x32, 0xC6, 0x47, 
  0x35, 0x8D, 0x33, 0xE7, 0xB8, 0x70, 0xF2, 0x87, 0xDB, 0xDB, 
  0xDB, 0xFD, 0x26, 0x5B, 0xA6, 0xB5, 0xA5, 0xDF, 0x9A, 0x5B, 
  0x57, 0xB7, 0xB5, 0x7D, 0xC4, 0xAD, 0xE5, 0xC4, 0x72, 0x56, 
  0x58, 0x11, 0x2B, 0xAB, 0x86, 0x5A, 0x76, 0x8A, 0x67, 0x3E, 
  0x82, 0x8C, 0x74, 0x91, 0xC9, 0x66, 0x32, 0x1D, 0x3D, 0xD3, 
  0x33, 0x80, 0xD1, 0x10, 0xE7, 0xC7, 0x59, 0x4E, 0x31, 0x65, 
  0x91, 0xED, 0x66, 0x18, 0xBE, 0x9B, 0x0C, 0x26, 0x78, 0x75, 
  0xE7, 0x9E, 0x0C, 0xE8, 0xC2, 0xE6, 0xFC, 0x3C, 0x53, 0x8C, 
  0xC1, 0x0B, 0x2A, 0x12, 0x31, 0xAA, 0xA8, 0x32, 0x1B, 0x68, 
  0x90, 0x68, 0xF9, 0xBC, 0x73, 0xB7, 0x3E, 0xE4, 0x09, 0xAE, 
  0xC9, 0xE9, 0xCD, 0xAC, 0x8A, 0xC4, 0x8C, 0x4F, 0x0F, 0x68, 
  0xDA, 0xA8, 0x76, 0x2A, 0x8A, 0x6D, 0x53, 0x7F, 0xAC, 0xD5, 
  0xFE, 0x3C, 0x9F, 0x5C, 0x9A, 0x15, 0x22, 0x16, 0x7F, 0x1C, 
  0xCC, 0x92, 0x13, 0x51, 0xBF, 0xCF, 0x7C, 0x95, 0xCA, 0xFF, 
  0xCB, 0x59, 0xAF, 0xE9, 0x25, 0x0F, 0x4A, 0xA6, 0x4C, 0x1E, 
  0x7A, 0xD4, 0x2D, 0x58, 0xB0, 0xB0, 0x2A, 0xD6, 0xB5, 0x8C, 
  0xBF, 0x15, 0xA7, 0xB3, 0x77, 0xEB, 0xEA, 0x03, 0xD0, 0x4A, 
  0xC4, 0x65, 0x9B, 0xD4, 0xC1, 0xE8, 0xD8, 0xB6, 0x44, 0xE1, 
  0x5B, 0x1E, 0x99, 0x1C, 0x7E, 0xDF, 0xB5, 0x62, 0x27, 0xB2, 
  0x93, 0x5E, 0xFA, 0x39, 0x70, 0xBF, 0x58, 0x4F, 0x23, 0xAF, 
  0x6A, 0xA7, 0xAD, 0x48, 0xE8, 0x14, 0x19, 0x76, 0x20, 0x1D, 
  0x1D, 0x63, 0x03, 0x42, 0xF3, 0x1D, 0x63, 0x03, 0x42, 0xF3, 
  0x17, 0xAF, 0x87, 0xBC, 0x87, 0x26, 0xEC, 0x84, 0x84, 0xAC, 
  0x85, 0x4D, 0xFD, 0xF7, 0x09, 0x1F, 0x55, 0x86, 0x90, 0x21, 
  0x81, 0xC8, 0xC8, 0xDA, 0x75, 0x4D, 0xAF, 0x15, 0xAF, 0x4E, 
  0xEE, 0x99, 0x69, 0x39, 0xB0, 0x7A, 0xF6, 0xFB, 0x94, 0x16, 
  0x41, 0x48, 0xEC, 0x38, 0x28, 0xCD, 0x05, 0x1C, 0xC6, 0x49, 
  0xCE, 0x18, 0xE0, 0x1A, 0x6E, 0x66, 0xE4, 0xA4, 0xF2, 0x96, 
  0x4B, 0xEC, 0x74, 0x24, 0xA7, 0xEF, 0xDA, 0x64, 0x0A, 0x8A, 
  0xA3, 0x29, 0xD7, 0xD8, 0xB5, 0x0A, 0xC1, 0x42, 0x08, 0xDC, 
  0x46, 0x2B, 0x33, 0x22, 0xF3, 0xC9, 0xDF, 0x22, 0x69, 0xCD, 
  0x66, 0xCF, 0x04, 0x2A, 0x07, 0x01, 0x2F, 0x05, 0xB6, 0x07, 
  0xBA, 0xF8, 0xE5, 0x7E, 0x9B, 0x52, 0xFC, 0x91, 0x49, 0x86, 
  0x25, 0xA3, 0x2E, 0x64, 0x9E, 0xF1, 0xFC, 0x0F, 0x35, 0x21, 
  0x28, 0x6D, 0x48, 0x63, 0xF5, 0x11, 0xD5, 0xC8, 0xD4, 0xC1, 
  0xD0, 0x05, 0x9C, 0x5C, 0xAA, 0x49, 0x1B, 0xEF, 0x75, 0xBD, 
  0x6A, 0x90, 0xBD, 0x13, 0x76, 0x6E, 0xAD, 0xFF, 0xE2, 0xFB, 
  0x25, 0x39, 0xBA, 0x15, 0x2D, 0xC3, 0x61, 0x75, 0x8E, 0xD7, 
  0xAD, 0xD4, 0x68, 0xE4, 0x2C, 0x7C, 0xE8, 0xD1, 0x46, 0x74, 
  0x49, 0x5F, 0x26, 0x01, 0xED, 0x84, 0xCD, 0x71, 0x2D, 0x27, 
  0x73, 0xE9, 0xAB, 0x87, 0x09, 0x14, 0xF0, 0x51, 0x0E, 0xCC, 
  0x0C, 0xCE, 0xBF, 0xBB, 0x2F, 0x86, 0x09, 0x89, 0x46, 0xDA, 
  0x59, 0x3C, 0x4D, 0xC4, 0x88, 0x19, 0x63, 0xF9, 0xA0, 0x76, 
  0x26, 0x45, 0x2D, 0xA4, 0x66, 0x76, 0x5B, 0x71, 0x21, 0x13, 
  0x36, 0xC1, 0x77, 0xEC, 0xF4, 0xF3, 0xED, 0x11, 0xA8, 0xF0, 
  0x2B, 0x4B, 0xA8, 0xA2, 0xB7, 0x32, 0x53, 0x58, 0x6B, 0xD1, 
  0x27, 0xEB, 0xE2, 0x05, 0xE7, 0x1F, 0x58, 0x68, 0x07, 0x3C, 
  0x9D, 0x1E, 0x30, 0x22, 0xC9, 0xA5, 0x85, 0x41, 0xD4, 0xDE, 
  0x45, 0x28, 0xB1, 0x26, 0x61, 0x16, 0xBB, 0x58, 0xF8, 0xB2, 
  0xAD, 0xF4, 0xEC, 0x9B, 0x92, 0x13, 0x0D, 0x64, 0xDA, 0x8F, 
  0x08, 0xD4, 0xF1, 0xCC, 0xEA, 0x33, 0xC1, 0x1B, 0xC5, 0x6D, 
  0xF6, 0xAB, 0x4E, 0x1F, 0x3F, 0x67, 0x7A, 0xF0, 0xE0, 0xEF, 
  0x1D, 0xA5, 0x3A, 0x18, 0xDD, 0x3B, 0x3C, 0x65, 0xA5, 0x07, 
  0x5D, 0x89, 0x29, 0xAC, 0xEA, 0x8B, 0x23, 0x2B, 0xD3, 0x58, 
  0x3B, 0xBC, 0xCC, 0x69, 0x3B, 0x20, 0x64, 0xE4, 0xDB, 0xCD, 
  0x4E, 0x61, 0xAC, 0x17, 0xAF, 0x98, 0xEA, 0xEA, 0x87, 0xDF, 
  0xDD, 0x36, 0x41, 0xF3, 0x46, 0x0D, 0x6B, 0xC9, 0xB1, 0x71, 
  0xF6, 0x0E, 0xD9, 0x0C, 0x7E, 0xA1, 0x43, 0xCD, 0x83, 0x04, 
  0xA4, 0x6A, 0xA9, 0x60, 0x14, 0x4D, 0x77, 0x88, 0x04, 0xBF, 
  0x3E, 0x51, 0xAB, 0xBE, 0x09, 0x2C, 0xC0, 0xE6, 0x1F, 0xE5, 
  0x42, 0xFF, 0x15, 0x32, 0xFC, 0x4A, 0x22, 0x94, 0xF8, 0x66, 
  0xCA, 0x8D, 0x91, 0xAF, 0x8B, 0x61, 0xA4, 0x38, 0x17, 0x1E, 
  0xD4, 0x6F, 0x19, 0x50, 0xBF, 0x68, 0xB0, 0x12, 0x91, 0x2A, 
  0xC0, 0x83, 0x12, 0xBD, 0x0C, 0x69, 0xC9, 0x95, 0xAC, 0x6E, 
  0xCF, 0xCE, 0xAE, 0xB4, 0x58, 0x6F, 0xA4, 0x26, 0xB8, 0x9C, 
  0x40, 0x54, 0x5B, 0xB1, 0x48, 0x80, 0xD2, 0x62, 0xC3, 0xBD, 
  0x8A, 0xFA, 0x60, 0x10, 0x17, 0xB2, 0xE8, 0x35, 0x11, 0x64, 
  0x85, 0x70, 0x3C, 0x9A, 0x10, 0x2A, 0x12, 0xD9, 0x9F, 0xBE, 
  0x69, 0x35, 0x63, 0x5E, 0x4A, 0x2F, 0x11, 0x50, 0xE2, 0x34, 
  0x78, 0x0E, 0xBD, 0x85, 0x57, 0x15, 0xAE, 0x7C, 0x0B, 0x85, 
  0xFA, 0x15, 0xDF, 0xF9, 0xA3, 0x7E, 0x0C, 0x15, 0xD8, 0x82, 
  0x86, 0xDD, 0xFE, 0x51, 0xDA, 0xA9, 0x31, 0x22, 0xDA, 0xDB, 
  0x0B, 0xFF, 0xE7, 0x33, 0x63, 0xA3, 0xEA, 0xE2, 0x61, 0x35, 
  0x19, 0x62, 0x35, 0x87, 0x13, 0xDE, 0x35, 0x85, 0xFC, 0x18, 
  0x42, 0xBC, 0x12, 0x0E, 0x77, 0x61, 0x25, 0x6C, 0x97, 0x1A, 
  0x2D, 0x72, 0x41, 0x1B, 0x99, 0x49, 0xAE, 0x7E, 0x97, 0x66, 
  0x72, 0x58, 0x48, 0xF9, 0x25, 0x61, 0x81, 0x38, 0x83, 0x6A, 
  0x7E, 0x71, 0xA0, 0x02, 0x38, 0x50, 0x93, 0x6D, 0xD3, 0x59, 
  0xC0, 0xE3, 0x3E, 0xD7, 0xA7, 0xC4, 0x8B, 0x5A, 0x49, 0x0C, 
  0x1B, 0x0B, 0x75, 0xD7, 0x96, 0x97, 0x1D, 0x32, 0xF9, 0x11, 
  0x24, 0xB0, 0xEE, 0x4C, 0x91, 0x9D, 0x66, 0x51, 0xA9, 0x3C, 
  0x4C, 0x41, 0xB8, 0xE5, 0xE7, 0x9A, 0x22, 0xD4, 0xF3, 0x1D, 
  0xBB, 0x3A, 0x06, 0x88, 0x2C, 0x07, 0x27, 0x85, 0x74, 0x0C, 
  0x0A, 0xB3, 0x99, 0x05, 0x2A, 0x60, 0xDF, 0x02, 0x7B, 0x60, 
  0xBB, 0xE5, 0xC4, 0xB7, 0x30, 0x57, 0x14, 0x81, 0x6D, 0xE5, 
  0x88, 0xD1, 0x43, 0x13, 0x83, 0x32, 0x99, 0xBF, 0x4D, 0x56, 
  0xC6, 0xA1, 0x2F, 0x66, 0x53, 0x87, 0xB3, 0x93, 0x14, 0xA3, 
  0x5E, 0x5E, 0x87, 0x86, 0x79, 0x33, 0xEC, 0xF1, 0xC0, 0x64, 
  0xAB, 0xF2, 0x23, 0x4D, 0x40, 0xDC, 0xC3, 0xC4, 0x3F, 0x3A, 
  0x15, 0x28, 0xB7, 0x86, 0xE1, 0xD7, 0x15, 0xDA, 0x74, 0xC1, 
  0x05, 0x44, 0x46, 0x05, 0x28, 0x07, 0xD6, 0xBE, 0xAF, 0x5C, 
  0xA8, 0x3B, 0x0B, 0x14, 0x4E, 0x14, 0xCF, 0xB7, 0xF1, 0xAB, 
  0x7C, 0xF5, 0x63, 0xF0, 0xDC, 0xC2, 0x30, 0xDB, 0xC5, 0x2F, 
  0xB9, 0xC5, 0x57, 0x2A, 0xBF, 0x50, 0xF5, 0x39, 0x5D, 0x5A, 
  0x76, 0x63, 0x93, 0x7B, 0x61, 0x1D, 0x12, 0xE7, 0xC3, 0x0B, 
  0x61, 0xA9, 0xFB, 0x26, 0x15, 0x62, 0xBA, 0x32, 0x35, 0x4E, 
  0x09, 0xC2, 0x32, 0x31, 0xB2, 0x95, 0xD5, 0x8E, 0x51, 0xA2, 
  0xC3, 0x34, 0x1D, 0xB8, 0x61, 0x8D, 0x25, 0xB5, 0x97, 0x1D, 
  0x02, 0xFA, 0x55, 0xF9, 0xA3, 0xB1, 0x4A, 0xBA, 0x4C, 0xBE, 
  0x2B, 0x41, 0xA8, 0x71, 0x5F, 0x1B, 0xDD, 0x2C, 0x54, 0x76, 
  0x58, 0xC1, 0xDE, 0x6E, 0x2A, 0x7C, 0x5F, 0x93, 0xA1, 0x04, 
  0xDF, 0x45, 0x31, 0xE0, 0x11, 0x32, 0x47, 0x9B, 0x1C, 0x0D, 
  0x04, 0x92, 0x02, 0x44, 0x29, 0xB2, 0x11, 0x32, 0x7C, 0xD6, 
  0xF1, 0x2E, 0xBE, 0xB3, 0xA9, 0x04, 0xE9, 0xFA, 0x51, 0x0F, 
  0x28, 0x45, 0x3E, 0x83, 0x2B, 0x6F, 0x6D, 0xFA, 0xE8, 0x85, 
  0x52, 0x0F, 0x97, 0x93, 0x1D, 0xA3, 0xF0, 0xAB, 0x07, 0x3F, 
  0xB8, 0x3A, 0x30, 0xF8, 0x92, 0x2D, 0x04, 0x98, 0x27, 0x06, 
  0xA0, 0xC2, 0x5C, 0x1D, 0xBE, 0x08, 0x60, 0x1E, 0xD7, 0x3F, 
  0x77, 0x02, 0xDF, 0x77, 0x2C, 0xA3, 0xCE, 0x64, 0x99, 0x51]

enc = [0x0F, 0x21, 0xCB, 0x47, 0xF6, 0xB0, 0x0E, 0xA0, 0x69, 0x51, 
  0x5A, 0x08, 0x47, 0x7E, 0x21, 0xD5, 0x8E, 0x31, 0xF4, 0xD6, 
  0xAF, 0xD0, 0x9A, 0x40, 0x03, 0x2B, 0xD6, 0x4C, 0xD7, 0x58, 
  0xD1, 0x47, 0xD6, 0xA9, 0x9E, 0x29, 0x64, 0x73, 0xAA, 0x48, 
  0xDF, 0x46, 0xC2, 0xBA]

inp = [BitVec('x1[%d]'%i, 8) for i in range(44)]
s = Solver()
for i in range(len(inp)):
    s.add(inp[i] > 0x20)
    s.add(inp[i] < 0x7f)
bef = 'de(RYpt3d_bu'
for i in range(len(bef)):
    s.add(inp[i] == ord(bef[i]))

i1 = i2 = 0
for i in range(24):
    if i % 2:
        inp0 = inp[0]
        for j in range(44):
            check1 = i2 % 3
            i2 += 1
            if check1 == 1:
                if j == 43:
                    inp[j] = (inp[j] + (inp0 ^ cipher[i1])) & 0xff
                else:
                    inp[j] = (inp[j] + (cipher[i1] ^ inp[j + 1])) & 0xff 
                i1 += 1
            elif check1 == 2:
                if j == 43:
                    inp[j] = (((inp0 + cipher[i1]) & 0xff) - inp[j]) & 0xff
                else:
                    inp[j] = (((cipher[i1] + inp[j + 1]) & 0xff) - inp[j]) & 0xff
                i1 += 1
            else:
                if j == 43:
                    inp[j] ^= ((inp0 - cipher[i1]) & 0xff)
                else:
                    inp[j] ^= ((inp[j + 1] - cipher[i1]) & 0xff)
                i1 += 1
    else:
        inp0 = inp[0]
        for k in range(44):
            check2 = i2 % 3
            i2 += 1
            if check2 == 1:
                if k:
                    tmp1 = (inp[k] + (cipher[i1] ^ inp[k - 1])) & 0xff
                    inp[k - 1] = tmp2
                    tmp2 = tmp1
                else:
                    tmp2 = (cipher[i1] + inp0) & 0xff 
                i1 += 1
            elif check2 == 2:
                if k:
                    tmp1 = (((cipher[i1] + inp[k - 1]) & 0xff) - inp[k]) & 0xff
                    inp[k - 1] = tmp2
                    tmp2 = tmp1
                else:
                    tmp2 = (inp0 - cipher[i1]) & 0xff
                i1 += 1
            else:
                if k:
                    tmp1 = inp[k] ^ (((inp[k - 1] - cipher[i1])) & 0xff)
                    inp[k - 1] = tmp2
                    tmp2 = tmp1
                else:
                    tmp2 = cipher[i1] ^ inp0
                i1 += 1
            if k == 43:
                inp[k] = tmp2

for i in range(44):
    s.add(inp[i] == enc[i])

if s.check() == sat:
    m = s.model()
    print(m)
    flag = ''
    solution = [m[inp[i]].as_long() for i in range(44)]
    flag += ''.join([chr(c) for c in solution])
    print(flag)
else:
    print('Fail')
```

Kết quả của script trên là chuỗi ``de(RYpt3d_but_m@y_be_you_5th_this_i5nt_f|agg``, tuy nhiên ngay từ ý nghĩa của nó ta đã biết được đây là flag fake

### Antidebug

Phân tích lại toàn bộ flow của chương trình, có thể nhận ra ở hàm ```rc4_prga```, sau khi mã hoá xong chương trình gọi đến hàm ```maybeCheckAntidebug```

![17](https://github.com/noobmannn/KCSC_CTF_2024/blob/1ce31dd1833783af1ae4ec12a50170c53f2262a6/behind%20the%20scenes/Img/17.png)

Hàm ```maybeCheckAntidebug``` đang tiến hành check xem tiến trình đang chạy có phải là cmd.exe (khi chạy bằng cmd), explorer.exe (khi nhấp chuột) và chall.exe hay không. Nếu có, thì chương trình sẽ chạy tiếp vào hàm ``sub_2F18D0``, còn nếu không thì chương trình sẽ bỏ qua hàm trên và chạy tiếp. Khi debug bằng ida thì tiến trình đang chạy sẽ là ida.exe, các trình debugger khác cũng sẽ chạy các tiến trình khác không phải 3 tiến tình trên. Đây chính là phương pháp Antidebug của file.

![18](https://github.com/noobmannn/KCSC_CTF_2024/blob/1ce31dd1833783af1ae4ec12a50170c53f2262a6/behind%20the%20scenes/Img/18.png)

Hàm ``sub_2F18D0`` đang thực hiện thay đổi các byte của biến ``Block``, chính là biến chứa toàn bộ data của file ```KCSC.dll```. 

![19](https://github.com/noobmannn/KCSC_CTF_2024/blob/1ce31dd1833783af1ae4ec12a50170c53f2262a6/behind%20the%20scenes/Img/19.png)

Ở ida mình sẽ SetIP để chạy qua hàm ``sub_2F18D0``, có thể thấy hàm ```HelloWorld``` của file bị thay đổi khá đáng chú ý:
- 12 kí tự đầu được so sánh với input được đổi sang chuỗi ``KCSC{kcscctf``
- Ciphertext bị thay đổi thành các giá trị dưới đây:
  ```python
  enc =  [0x41, 0xA5, 0xC3, 0xC7, 0x9A, 0x35, 0x7E, 0xE9, 0x20, 0xB8, 
  0x4C, 0xB8, 0x46, 0x50, 0x29, 0x0A, 0xAC, 0xC2, 0x19, 0xFA, 
  0xAB, 0xCC, 0xE4, 0xF4, 0x92, 0x68, 0xFE, 0xDF, 0xD6, 0x22, 
  0xAA, 0x2A, 0x3D, 0xA5, 0x3A, 0x58, 0x28, 0x84, 0x35, 0x0F, 
  0xE6, 0xE9, 0x31, 0x92]
  ```

Từ đây sửa lại script để lấy flag

```python
from z3 import *

cipher = [0xD1, 0x46, 0x40, 0x91, 0x2F, 0x64, 0x42, 0xD6, 0xE9, 0x2D, 
  0x19, 0x28, 0x10, 0xC8, 0x79, 0x88, 0x70, 0x32, 0xC6, 0x47, 
  0x35, 0x8D, 0x33, 0xE7, 0xB8, 0x70, 0xF2, 0x87, 0xDB, 0xDB, 
  0xDB, 0xFD, 0x26, 0x5B, 0xA6, 0xB5, 0xA5, 0xDF, 0x9A, 0x5B, 
  0x57, 0xB7, 0xB5, 0x7D, 0xC4, 0xAD, 0xE5, 0xC4, 0x72, 0x56, 
  0x58, 0x11, 0x2B, 0xAB, 0x86, 0x5A, 0x76, 0x8A, 0x67, 0x3E, 
  0x82, 0x8C, 0x74, 0x91, 0xC9, 0x66, 0x32, 0x1D, 0x3D, 0xD3, 
  0x33, 0x80, 0xD1, 0x10, 0xE7, 0xC7, 0x59, 0x4E, 0x31, 0x65, 
  0x91, 0xED, 0x66, 0x18, 0xBE, 0x9B, 0x0C, 0x26, 0x78, 0x75, 
  0xE7, 0x9E, 0x0C, 0xE8, 0xC2, 0xE6, 0xFC, 0x3C, 0x53, 0x8C, 
  0xC1, 0x0B, 0x2A, 0x12, 0x31, 0xAA, 0xA8, 0x32, 0x1B, 0x68, 
  0x90, 0x68, 0xF9, 0xBC, 0x73, 0xB7, 0x3E, 0xE4, 0x09, 0xAE, 
  0xC9, 0xE9, 0xCD, 0xAC, 0x8A, 0xC4, 0x8C, 0x4F, 0x0F, 0x68, 
  0xDA, 0xA8, 0x76, 0x2A, 0x8A, 0x6D, 0x53, 0x7F, 0xAC, 0xD5, 
  0xFE, 0x3C, 0x9F, 0x5C, 0x9A, 0x15, 0x22, 0x16, 0x7F, 0x1C, 
  0xCC, 0x92, 0x13, 0x51, 0xBF, 0xCF, 0x7C, 0x95, 0xCA, 0xFF, 
  0xCB, 0x59, 0xAF, 0xE9, 0x25, 0x0F, 0x4A, 0xA6, 0x4C, 0x1E, 
  0x7A, 0xD4, 0x2D, 0x58, 0xB0, 0xB0, 0x2A, 0xD6, 0xB5, 0x8C, 
  0xBF, 0x15, 0xA7, 0xB3, 0x77, 0xEB, 0xEA, 0x03, 0xD0, 0x4A, 
  0xC4, 0x65, 0x9B, 0xD4, 0xC1, 0xE8, 0xD8, 0xB6, 0x44, 0xE1, 
  0x5B, 0x1E, 0x99, 0x1C, 0x7E, 0xDF, 0xB5, 0x62, 0x27, 0xB2, 
  0x93, 0x5E, 0xFA, 0x39, 0x70, 0xBF, 0x58, 0x4F, 0x23, 0xAF, 
  0x6A, 0xA7, 0xAD, 0x48, 0xE8, 0x14, 0x19, 0x76, 0x20, 0x1D, 
  0x1D, 0x63, 0x03, 0x42, 0xF3, 0x1D, 0x63, 0x03, 0x42, 0xF3, 
  0x17, 0xAF, 0x87, 0xBC, 0x87, 0x26, 0xEC, 0x84, 0x84, 0xAC, 
  0x85, 0x4D, 0xFD, 0xF7, 0x09, 0x1F, 0x55, 0x86, 0x90, 0x21, 
  0x81, 0xC8, 0xC8, 0xDA, 0x75, 0x4D, 0xAF, 0x15, 0xAF, 0x4E, 
  0xEE, 0x99, 0x69, 0x39, 0xB0, 0x7A, 0xF6, 0xFB, 0x94, 0x16, 
  0x41, 0x48, 0xEC, 0x38, 0x28, 0xCD, 0x05, 0x1C, 0xC6, 0x49, 
  0xCE, 0x18, 0xE0, 0x1A, 0x6E, 0x66, 0xE4, 0xA4, 0xF2, 0x96, 
  0x4B, 0xEC, 0x74, 0x24, 0xA7, 0xEF, 0xDA, 0x64, 0x0A, 0x8A, 
  0xA3, 0x29, 0xD7, 0xD8, 0xB5, 0x0A, 0xC1, 0x42, 0x08, 0xDC, 
  0x46, 0x2B, 0x33, 0x22, 0xF3, 0xC9, 0xDF, 0x22, 0x69, 0xCD, 
  0x66, 0xCF, 0x04, 0x2A, 0x07, 0x01, 0x2F, 0x05, 0xB6, 0x07, 
  0xBA, 0xF8, 0xE5, 0x7E, 0x9B, 0x52, 0xFC, 0x91, 0x49, 0x86, 
  0x25, 0xA3, 0x2E, 0x64, 0x9E, 0xF1, 0xFC, 0x0F, 0x35, 0x21, 
  0x28, 0x6D, 0x48, 0x63, 0xF5, 0x11, 0xD5, 0xC8, 0xD4, 0xC1, 
  0xD0, 0x05, 0x9C, 0x5C, 0xAA, 0x49, 0x1B, 0xEF, 0x75, 0xBD, 
  0x6A, 0x90, 0xBD, 0x13, 0x76, 0x6E, 0xAD, 0xFF, 0xE2, 0xFB, 
  0x25, 0x39, 0xBA, 0x15, 0x2D, 0xC3, 0x61, 0x75, 0x8E, 0xD7, 
  0xAD, 0xD4, 0x68, 0xE4, 0x2C, 0x7C, 0xE8, 0xD1, 0x46, 0x74, 
  0x49, 0x5F, 0x26, 0x01, 0xED, 0x84, 0xCD, 0x71, 0x2D, 0x27, 
  0x73, 0xE9, 0xAB, 0x87, 0x09, 0x14, 0xF0, 0x51, 0x0E, 0xCC, 
  0x0C, 0xCE, 0xBF, 0xBB, 0x2F, 0x86, 0x09, 0x89, 0x46, 0xDA, 
  0x59, 0x3C, 0x4D, 0xC4, 0x88, 0x19, 0x63, 0xF9, 0xA0, 0x76, 
  0x26, 0x45, 0x2D, 0xA4, 0x66, 0x76, 0x5B, 0x71, 0x21, 0x13, 
  0x36, 0xC1, 0x77, 0xEC, 0xF4, 0xF3, 0xED, 0x11, 0xA8, 0xF0, 
  0x2B, 0x4B, 0xA8, 0xA2, 0xB7, 0x32, 0x53, 0x58, 0x6B, 0xD1, 
  0x27, 0xEB, 0xE2, 0x05, 0xE7, 0x1F, 0x58, 0x68, 0x07, 0x3C, 
  0x9D, 0x1E, 0x30, 0x22, 0xC9, 0xA5, 0x85, 0x41, 0xD4, 0xDE, 
  0x45, 0x28, 0xB1, 0x26, 0x61, 0x16, 0xBB, 0x58, 0xF8, 0xB2, 
  0xAD, 0xF4, 0xEC, 0x9B, 0x92, 0x13, 0x0D, 0x64, 0xDA, 0x8F, 
  0x08, 0xD4, 0xF1, 0xCC, 0xEA, 0x33, 0xC1, 0x1B, 0xC5, 0x6D, 
  0xF6, 0xAB, 0x4E, 0x1F, 0x3F, 0x67, 0x7A, 0xF0, 0xE0, 0xEF, 
  0x1D, 0xA5, 0x3A, 0x18, 0xDD, 0x3B, 0x3C, 0x65, 0xA5, 0x07, 
  0x5D, 0x89, 0x29, 0xAC, 0xEA, 0x8B, 0x23, 0x2B, 0xD3, 0x58, 
  0x3B, 0xBC, 0xCC, 0x69, 0x3B, 0x20, 0x64, 0xE4, 0xDB, 0xCD, 
  0x4E, 0x61, 0xAC, 0x17, 0xAF, 0x98, 0xEA, 0xEA, 0x87, 0xDF, 
  0xDD, 0x36, 0x41, 0xF3, 0x46, 0x0D, 0x6B, 0xC9, 0xB1, 0x71, 
  0xF6, 0x0E, 0xD9, 0x0C, 0x7E, 0xA1, 0x43, 0xCD, 0x83, 0x04, 
  0xA4, 0x6A, 0xA9, 0x60, 0x14, 0x4D, 0x77, 0x88, 0x04, 0xBF, 
  0x3E, 0x51, 0xAB, 0xBE, 0x09, 0x2C, 0xC0, 0xE6, 0x1F, 0xE5, 
  0x42, 0xFF, 0x15, 0x32, 0xFC, 0x4A, 0x22, 0x94, 0xF8, 0x66, 
  0xCA, 0x8D, 0x91, 0xAF, 0x8B, 0x61, 0xA4, 0x38, 0x17, 0x1E, 
  0xD4, 0x6F, 0x19, 0x50, 0xBF, 0x68, 0xB0, 0x12, 0x91, 0x2A, 
  0xC0, 0x83, 0x12, 0xBD, 0x0C, 0x69, 0xC9, 0x95, 0xAC, 0x6E, 
  0xCF, 0xCE, 0xAE, 0xB4, 0x58, 0x6F, 0xA4, 0x26, 0xB8, 0x9C, 
  0x40, 0x54, 0x5B, 0xB1, 0x48, 0x80, 0xD2, 0x62, 0xC3, 0xBD, 
  0x8A, 0xFA, 0x60, 0x10, 0x17, 0xB2, 0xE8, 0x35, 0x11, 0x64, 
  0x85, 0x70, 0x3C, 0x9A, 0x10, 0x2A, 0x12, 0xD9, 0x9F, 0xBE, 
  0x69, 0x35, 0x63, 0x5E, 0x4A, 0x2F, 0x11, 0x50, 0xE2, 0x34, 
  0x78, 0x0E, 0xBD, 0x85, 0x57, 0x15, 0xAE, 0x7C, 0x0B, 0x85, 
  0xFA, 0x15, 0xDF, 0xF9, 0xA3, 0x7E, 0x0C, 0x15, 0xD8, 0x82, 
  0x86, 0xDD, 0xFE, 0x51, 0xDA, 0xA9, 0x31, 0x22, 0xDA, 0xDB, 
  0x0B, 0xFF, 0xE7, 0x33, 0x63, 0xA3, 0xEA, 0xE2, 0x61, 0x35, 
  0x19, 0x62, 0x35, 0x87, 0x13, 0xDE, 0x35, 0x85, 0xFC, 0x18, 
  0x42, 0xBC, 0x12, 0x0E, 0x77, 0x61, 0x25, 0x6C, 0x97, 0x1A, 
  0x2D, 0x72, 0x41, 0x1B, 0x99, 0x49, 0xAE, 0x7E, 0x97, 0x66, 
  0x72, 0x58, 0x48, 0xF9, 0x25, 0x61, 0x81, 0x38, 0x83, 0x6A, 
  0x7E, 0x71, 0xA0, 0x02, 0x38, 0x50, 0x93, 0x6D, 0xD3, 0x59, 
  0xC0, 0xE3, 0x3E, 0xD7, 0xA7, 0xC4, 0x8B, 0x5A, 0x49, 0x0C, 
  0x1B, 0x0B, 0x75, 0xD7, 0x96, 0x97, 0x1D, 0x32, 0xF9, 0x11, 
  0x24, 0xB0, 0xEE, 0x4C, 0x91, 0x9D, 0x66, 0x51, 0xA9, 0x3C, 
  0x4C, 0x41, 0xB8, 0xE5, 0xE7, 0x9A, 0x22, 0xD4, 0xF3, 0x1D, 
  0xBB, 0x3A, 0x06, 0x88, 0x2C, 0x07, 0x27, 0x85, 0x74, 0x0C, 
  0x0A, 0xB3, 0x99, 0x05, 0x2A, 0x60, 0xDF, 0x02, 0x7B, 0x60, 
  0xBB, 0xE5, 0xC4, 0xB7, 0x30, 0x57, 0x14, 0x81, 0x6D, 0xE5, 
  0x88, 0xD1, 0x43, 0x13, 0x83, 0x32, 0x99, 0xBF, 0x4D, 0x56, 
  0xC6, 0xA1, 0x2F, 0x66, 0x53, 0x87, 0xB3, 0x93, 0x14, 0xA3, 
  0x5E, 0x5E, 0x87, 0x86, 0x79, 0x33, 0xEC, 0xF1, 0xC0, 0x64, 
  0xAB, 0xF2, 0x23, 0x4D, 0x40, 0xDC, 0xC3, 0xC4, 0x3F, 0x3A, 
  0x15, 0x28, 0xB7, 0x86, 0xE1, 0xD7, 0x15, 0xDA, 0x74, 0xC1, 
  0x05, 0x44, 0x46, 0x05, 0x28, 0x07, 0xD6, 0xBE, 0xAF, 0x5C, 
  0xA8, 0x3B, 0x0B, 0x14, 0x4E, 0x14, 0xCF, 0xB7, 0xF1, 0xAB, 
  0x7C, 0xF5, 0x63, 0xF0, 0xDC, 0xC2, 0x30, 0xDB, 0xC5, 0x2F, 
  0xB9, 0xC5, 0x57, 0x2A, 0xBF, 0x50, 0xF5, 0x39, 0x5D, 0x5A, 
  0x76, 0x63, 0x93, 0x7B, 0x61, 0x1D, 0x12, 0xE7, 0xC3, 0x0B, 
  0x61, 0xA9, 0xFB, 0x26, 0x15, 0x62, 0xBA, 0x32, 0x35, 0x4E, 
  0x09, 0xC2, 0x32, 0x31, 0xB2, 0x95, 0xD5, 0x8E, 0x51, 0xA2, 
  0xC3, 0x34, 0x1D, 0xB8, 0x61, 0x8D, 0x25, 0xB5, 0x97, 0x1D, 
  0x02, 0xFA, 0x55, 0xF9, 0xA3, 0xB1, 0x4A, 0xBA, 0x4C, 0xBE, 
  0x2B, 0x41, 0xA8, 0x71, 0x5F, 0x1B, 0xDD, 0x2C, 0x54, 0x76, 
  0x58, 0xC1, 0xDE, 0x6E, 0x2A, 0x7C, 0x5F, 0x93, 0xA1, 0x04, 
  0xDF, 0x45, 0x31, 0xE0, 0x11, 0x32, 0x47, 0x9B, 0x1C, 0x0D, 
  0x04, 0x92, 0x02, 0x44, 0x29, 0xB2, 0x11, 0x32, 0x7C, 0xD6, 
  0xF1, 0x2E, 0xBE, 0xB3, 0xA9, 0x04, 0xE9, 0xFA, 0x51, 0x0F, 
  0x28, 0x45, 0x3E, 0x83, 0x2B, 0x6F, 0x6D, 0xFA, 0xE8, 0x85, 
  0x52, 0x0F, 0x97, 0x93, 0x1D, 0xA3, 0xF0, 0xAB, 0x07, 0x3F, 
  0xB8, 0x3A, 0x30, 0xF8, 0x92, 0x2D, 0x04, 0x98, 0x27, 0x06, 
  0xA0, 0xC2, 0x5C, 0x1D, 0xBE, 0x08, 0x60, 0x1E, 0xD7, 0x3F, 
  0x77, 0x02, 0xDF, 0x77, 0x2C, 0xA3, 0xCE, 0x64, 0x99, 0x51]

enc =  [0x41, 0xA5, 0xC3, 0xC7, 0x9A, 0x35, 0x7E, 0xE9, 0x20, 0xB8, 
  0x4C, 0xB8, 0x46, 0x50, 0x29, 0x0A, 0xAC, 0xC2, 0x19, 0xFA, 
  0xAB, 0xCC, 0xE4, 0xF4, 0x92, 0x68, 0xFE, 0xDF, 0xD6, 0x22, 
  0xAA, 0x2A, 0x3D, 0xA5, 0x3A, 0x58, 0x28, 0x84, 0x35, 0x0F, 
  0xE6, 0xE9, 0x31, 0x92]

inp = [BitVec('x1[%d]'%i, 8) for i in range(44)]
s = Solver()
for i in range(len(inp)):
    s.add(inp[i] > 0x20)
    s.add(inp[i] < 0x7f)
bef = 'KCSC{kcscctf'
for i in range(len(bef)):
    s.add(inp[i] == ord(bef[i]))

i1 = i2 = 0
for i in range(24):
    if i % 2:
        inp0 = inp[0]
        for j in range(44):
            check1 = i2 % 3
            i2 += 1
            if check1 == 1:
                if j == 43:
                    inp[j] = (inp[j] + (inp0 ^ cipher[i1])) & 0xff
                else:
                    inp[j] = (inp[j] + (cipher[i1] ^ inp[j + 1])) & 0xff 
                i1 += 1
            elif check1 == 2:
                if j == 43:
                    inp[j] = (((inp0 + cipher[i1]) & 0xff) - inp[j]) & 0xff
                else:
                    inp[j] = (((cipher[i1] + inp[j + 1]) & 0xff) - inp[j]) & 0xff
                i1 += 1
            else:
                if j == 43:
                    inp[j] ^= ((inp0 - cipher[i1]) & 0xff)
                else:
                    inp[j] ^= ((inp[j + 1] - cipher[i1]) & 0xff)
                i1 += 1
    else:
        inp0 = inp[0]
        for k in range(44):
            check2 = i2 % 3
            i2 += 1
            if check2 == 1:
                if k:
                    tmp1 = (inp[k] + (cipher[i1] ^ inp[k - 1])) & 0xff
                    inp[k - 1] = tmp2
                    tmp2 = tmp1
                else:
                    tmp2 = (cipher[i1] + inp0) & 0xff 
                i1 += 1
            elif check2 == 2:
                if k:
                    tmp1 = (((cipher[i1] + inp[k - 1]) & 0xff) - inp[k]) & 0xff
                    inp[k - 1] = tmp2
                    tmp2 = tmp1
                else:
                    tmp2 = (inp0 - cipher[i1]) & 0xff
                i1 += 1
            else:
                if k:
                    tmp1 = inp[k] ^ (((inp[k - 1] - cipher[i1])) & 0xff)
                    inp[k - 1] = tmp2
                    tmp2 = tmp1
                else:
                    tmp2 = cipher[i1] ^ inp0
                i1 += 1
            if k == 43:
                inp[k] = tmp2

for i in range(44):
    s.add(inp[i] == enc[i])

if s.check() == sat:
    m = s.model()
    print(m)
    flag = ''
    solution = [m[inp[i]].as_long() for i in range(44)]
    flag += ''.join([chr(c) for c in solution])
    print(flag)
else:
    print('Fail')
```

Kết quả của script trên là chuối ``KCSC{kcscctf_2024_1_l0v3_y0u_@RSeqTke3a5v3D}``. Đây chính là Flag của bài.

# Flag

```KCSC{kcscctf_2024_1_l0v3_y0u_@RSeqTke3a5v3D}```
